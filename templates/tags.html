<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–µ–≥–∞–º–∏</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>
<body>
    {% raw %}
    <div id="app">
    <header>
        <h1>üè∑Ô∏è –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–µ–≥–∞–º–∏</h1>
        <canvas id="sparkleCanvas" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: -1;"></canvas>
        <a href="/" class="back-link">‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –º–æ–¥–∞–º</a>
    </header>

    <main class="container">
        <!-- –§–æ—Ä–º–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ç–µ–≥–∞ -->
        <div class="tag-form">
            <h2>–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π —Ç–µ–≥</h2>
            <form @submit.prevent="addTag">
                <div class="form-group">
                    <input type="text" v-model="newTagName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–µ–≥–∞ (–º–∏–Ω–∏–º—É–º 2 —Å–∏–º–≤–æ–ª–∞)" 
                           required maxlength="50">
                </div>
                <button type="submit" class="tag-btn tag-btn-add">+ –î–æ–±–∞–≤–∏—Ç—å —Ç–µ–≥</button>
            </form>
        </div>

        <!-- –°–ø–∏—Å–æ–∫ —Ç–µ–≥–æ–≤ -->
        <div class="tags-list">
            <h2>–°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Ç–µ–≥–∏ ({{ tags.length }})</h2>
            
            <div class="flash-container" v-if="flashMessage">
                <div :class="'flash-' + flashType">{{ flashMessage }}</div>
            </div>
            
            <div v-if="tags.length > 0">
                <table class="tags-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                            <th>–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è</th>
                            <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr v-for="tag in tags" :key="tag.id">
                            <td>
                                <span class="tag-link">{{ tag.name }}</span>
                            </td>
                            <td>
                                <form @submit.prevent="editTag(tag)" class="edit-form">
                                    <input type="text" v-model="tag.editName" 
                                        class="tag-input" maxlength="50">
                                    <button type="submit" class="tag-btn tag-btn-save">üíæ</button>
                                </form>
                            </td>
                            <td>{{ tag.created_at || 'N/A' }}</td>
                            <td>
                                <button @click="deleteTag(tag)" class="tag-btn tag-btn-delete">üóëÔ∏è</button>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <div v-else>
                <p class="empty">–ù–µ—Ç —Å–æ–∑–¥–∞–Ω–Ω—ã—Ö —Ç–µ–≥–æ–≤. –î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤—ã–π!</p>
            </div>
        </div>
    </main>
    </div>
    {% endraw %}

    <script>
    const { createApp } = Vue;

    createApp({
        data() {
            return {
                tags: [],
                newTagName: '',
                flashMessage: '',
                flashType: 'success'
            }
        },
        methods: {
            async fetchTags() {
                try {
                    const response = await axios.get('/api/tags');
                    this.tags = response.data.tags.map(tag => ({
                        ...tag,
                        editName: tag.name // –ø–æ–ª–µ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
                    }));
                } catch (error) {
                    this.showFlash('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–µ–≥–æ–≤', 'danger');
                }
            },
            async addTag() {
                if (this.newTagName.length < 2) {
                    alert('–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–µ–≥–∞ –¥–æ–ª–∂–Ω–æ —Å–æ–¥–µ—Ä–∂–∞—Ç—å –º–∏–Ω–∏–º—É–º 2 —Å–∏–º–≤–æ–ª–∞');
                    return;
                }
                try {
                    const response = await axios.post('/add_tag', { tag_name: this.newTagName });
                    if (response.data.success) {
                        this.showFlash(response.data.message, 'success');
                        this.newTagName = '';
                        await this.fetchTags();
                    } else {
                        this.showFlash(response.data.message, 'danger');
                    }
                } catch (error) {
                    this.showFlash('–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏', 'danger');
                }
            },
            async editTag(tag) {
                if (tag.editName.length < 2) {
                    alert('–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–µ–≥–∞ –¥–æ–ª–∂–Ω–æ —Å–æ–¥–µ—Ä–∂–∞—Ç—å –º–∏–Ω–∏–º—É–º 2 —Å–∏–º–≤–æ–ª–∞');
                    return;
                }
                try {
                    const response = await axios.post(`/edit_tag/${tag.id}`, { tag_name: tag.editName });
                    if (response.data.success) {
                        tag.name = tag.editName;
                        this.showFlash(response.data.message, 'success');
                    } else {
                        this.showFlash(response.data.message, 'danger');
                    }
                } catch (error) {
                    this.showFlash('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏', 'danger');
                }
            },
            async deleteTag(tag) {
                if (!confirm(`–£–¥–∞–ª–∏—Ç—å —Ç–µ–≥ "${tag.name}"? –í—Å–µ —Å–≤—è–∑–∞–Ω–Ω—ã–µ –º–æ–¥—ã –ø–æ—Ç–µ—Ä—è—é—Ç —ç—Ç–æ—Ç —Ç–µ–≥.`)) return;
                try {
                    const response = await axios.post(`/delete_tag/${tag.id}`);
                    if (response.data.success) {
                        this.tags = this.tags.filter(t => t.id !== tag.id);
                        this.showFlash(response.data.message, 'success');
                    } else {
                        this.showFlash(response.data.message, 'danger');
                    }
                } catch (error) {
                    this.showFlash('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏', 'danger');
                }
            },
            showFlash(message, type) {
                this.flashMessage = message;
                this.flashType = type;
                setTimeout(() => {
                    this.flashMessage = '';
                }, 3000);
            },
            initSparkles() {
        const canvas = document.getElementById('sparkleCanvas');
        if (!canvas) return;
        const ctx = canvas.getContext('2d');

        // –ê–¥–∞–ø—Ç–∞—Ü–∏—è –ø–æ–¥ —Ä–∞–∑–º–µ—Ä header
        const resizeCanvas = () => {
            const rect = canvas.parentElement.getBoundingClientRect();
            canvas.width = rect.width;
            canvas.height = rect.height;
        };
        resizeCanvas();
        window.addEventListener('resize', resizeCanvas);

        // === –ú–µ–ª–∫–∏–µ –±–ª–µ—Å—Ç–∫–∏ (80 —à—Ç) ===
        const sparkles = [];
        const count = 500;

        for (let i = 0; i < count; i++) {
            sparkles.push({
                x: Math.random() * canvas.width,
                y: Math.random() * canvas.height,
                baseRadius: Math.random() * 0.3 + 0.1, // 0.5‚Äì1.5px
                pulseSpeed: Math.random() * 4 + 3, // 0.5‚Äì1.3 –ì—Ü
                phase: Math.random() * Math.PI * 2,
            });
        }

        // === –ê–Ω–∏–º–∞—Ü–∏—è ===
        function animate() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            const t = Date.now() / 1000;

            // –†–∏—Å—É–µ–º –º–µ–ª–∫–∏–µ –±–ª–µ—Å—Ç–∫–∏
            for (const s of sparkles) {
                const pulse = Math.sin(t * s.pulseSpeed + s.phase) * 0.5 + 0.5; // 0 ‚Üí 1
                const radius = s.baseRadius * (1 + pulse * 0.8);
                const opacity = 0.3 + pulse * 0.7;

                ctx.beginPath();
                ctx.arc(s.x, s.y, radius, 0, Math.PI * 2);
                ctx.fillStyle = `rgba(255, 255, 255, ${opacity})`;
                ctx.fill();

                // –§–∏–æ–ª–µ—Ç–æ–≤–æ–µ —Å–≤–µ—á–µ–Ω–∏–µ
                ctx.shadowBlur = 10 * pulse;
                ctx.shadowColor = `rgba(139, 92, 246, ${pulse * 0.6})`;
                ctx.fill();
                ctx.shadowBlur = 0;
            }

            requestAnimationFrame(animate);
        }

        animate();
            }
        },
        mounted() {
            this.fetchTags();
            this.initSparkles();
        }
    }).mount('#app');
    </script>
</body>
</html>