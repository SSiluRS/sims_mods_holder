<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–ú–æ–∏ –º–æ–¥—ã –¥–ª—è Sims 4</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <header>
        <h1>üìÅ –ú–æ–∏ –º–æ–¥—ã –¥–ª—è Sims 4</h1>
        <canvas id="sparkleCanvas" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: -1;"></canvas>
        <div class="header-actions">
            <a href="/tags" class="tag-btn header-tag-btn">üè∑Ô∏è –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–µ–≥–∞–º–∏</a>
            <form action="/add" method="POST">
                <input type="url" name="mod_url" 
                       placeholder="https://sims-market.ru/mod/..." 
                       required>
                <button type="submit">+ –î–æ–±–∞–≤–∏—Ç—å –º–æ–¥</button>
            </form>
        </div>
    </header>

    <!-- –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —Ñ–∏–ª—å—Ç—Ä–∞ -->
    {% if current_filter_tags %}
    <div class="filter-indicator">
        <span class="filter-text">–§–∏–ª—å—Ç—Ä: 
            {% for tag_id, tag_name in current_filter_names %}
                {{ tag_name }}{% if not loop.last %}, {% endif %}
            {% endfor %}
        </span>
        <a href="/" class="filter-clear-btn">√ó</a>
    </div>
    {% endif %}

    <!-- Flash-—Å–æ–æ–±—â–µ–Ω–∏—è –≤–≤–µ—Ä—Ö—É —Å—Ç—Ä–∞–Ω–∏—Ü—ã -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <div class="flash-container">
                {% for category, message in messages %}
                    <div class="flash-{{ category }}">{{ message }}</div>
                {% endfor %}
            </div>
        {% endif %}
    {% endwith %}

    <main class="cards-container">
        {% for mod in mods %}
        <div class="card" data-mod-id="{{ mod[0] }}">
            <!-- –ö–Ω–æ–ø–∫–∞ "—Ç—Ä–∏ —Ç–æ—á–∫–∏" –≤ –ø—Ä–∞–≤–æ–º –≤–µ—Ä—Ö–Ω–µ–º —É–≥–ª—É -->
            <div class="card-actions">
                <div class="dropdown">
                    <button class="dropdown-btn">‚ãÆ</button>
                    <div class="dropdown-content">
                        <!-- –û—Ç–∫—Ä—ã—Ç—å –Ω–∞ Sims-Market -->
                        <a href="{{ mod[3] | escape }}" target="_blank" class="dropdown-item">
                            üåê –û—Ç–∫—Ä—ã—Ç—å –Ω–∞ Sims-Market
                        </a>
                        <!-- –°—Å—ã–ª–∫–∞ –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è -->
                        <a href="#" class="dropdown-item" 
                           onclick="downloadMod('{{ mod[6] | escape }}'); return false;">
                            ‚¨áÔ∏è –°–∫–∞—á–∞—Ç—å ZIP
                        </a>
                        <!-- –ö–Ω–æ–ø–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –≤ —Å—Ç–∏–ª–µ dropdown-item -->
                        <a href="#" class="dropdown-item delete-btn" 
                           onclick="deleteMod({{ mod[0] }}, '{{ mod[1] | escape }}'); return false;">
                            üóë –£–¥–∞–ª–∏—Ç—å –º–æ–¥
                        </a>
                    </div>
                </div>
            </div>
            
            <img src="{{ mod[2] | escape }}" alt="{{ mod[1] | escape }}" 
                 onerror="this.src='https://via.placeholder.com/250x150?text=No+Image'">
            
            <div class="card-content">
                <!-- –í–µ—Ä—Ö–Ω—è—è —á–∞—Å—Ç—å (–∑–∞–≥–æ–ª–æ–≤–æ–∫) -->
                <div class="content-top">
                    <h2>{{ mod[1] | escape }}</h2>                       
                </div>
                
                <!-- –ù–∏–∂–Ω—è—è —á–∞—Å—Ç—å (—Å—Å—ã–ª–∫–∏ –∏ –∫–Ω–æ–ø–∫–∏) -->
                <div class="content-bottom">
                    <!-- –¢–µ–≥–∏ –∏ –ø–ª—é—Å–∏–∫ –≤ –æ–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–µ -->
                    <div class="assigned-tags">
                        {% set mod_tags = tags_for_mod[mod[0]] %}
                        {% if mod_tags %}
                            {% for tag in mod_tags %}
                            <div class="assigned-tag-container">
                                <span class="assigned-tag" onclick="filterByTag({{ tag[0] }})">
                                    {{ tag[1] }}
                                    <span class="assigned-tag-delete" onclick="removeTagFromMod(event, {{ mod[0] }}, {{ tag[0] }})">√ó</span>
                                </span>
                            </div>
                            {% endfor %}
                        {% endif %}
                        
                        <!-- –ü–ª—é—Å–∏–∫ –≤ —Å—Ç–∏–ª–µ —Ç–µ–≥–∞ -->
                        <button class="tag-plus-btn" onclick="toggleTagDropdown(this)">+</button>
                        <div class="tag-dropdown">
                            {% for tag in all_tags %}
                            <button type="button" class="tag-item" 
                                    onclick="addTagToMod(event, {{ mod[0] }}, {{ tag[0] }})">
                                {{ tag[1] }}
                            </button>
                            {% endfor %}
                        </div>
                    </div>                    
                </div>
            </div>
        </div>
        {% else %}
        <p class="empty">
            {% if current_filter_tags %}
                –ù–µ—Ç –º–æ–¥–æ–≤ —Å –≤—ã–±—Ä–∞–Ω–Ω—ã–º–∏ —Ç–µ–≥–∞–º–∏. 
                <a href="/">–ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ</a>
            {% else %}
                –ù–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã—Ö –º–æ–¥–æ–≤. –î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤—ã–π!
            {% endif %}
        </p>
        {% endfor %}
    </main>

    <script>
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –≤—ã–ø–∞–¥–∞—é—â–µ–≥–æ —Å–ø–∏—Å–∫–∞
    function toggleTagDropdown(button) {
        const dropdown = button.nextElementSibling;
        dropdown.classList.toggle('show');
        
        // –ó–∞–∫—Ä—ã—Ç—å –¥—Ä—É–≥–∏–µ –≤—ã–ø–∞–¥–∞—é—â–∏–µ —Å–ø–∏—Å–∫–∏
        document.querySelectorAll('.tag-dropdown').forEach(d => {
            if (d !== dropdown && d.classList.contains('show')) {
                d.classList.remove('show');
            }
        });
    }

    function deleteMod(modId, modTitle) {
        if (confirm('–£–¥–∞–ª–∏—Ç—å –º–æ–¥ "' + modTitle + '"?')) {
            // –°–æ–∑–¥–∞–µ–º —Ñ–æ—Ä–º—É –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ POST-–∑–∞–ø—Ä–æ—Å–∞
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = '/delete/' + modId;
            document.body.appendChild(form);
            form.submit();
        }
    };

    // –ó–∞–∫—Ä—ã—Ç—å –≤—ã–ø–∞–¥–∞—é—â–∏–µ —Å–ø–∏—Å–∫–∏ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –∏—Ö
    document.addEventListener('click', function(e) {
        if (!e.target.closest('.tag-plus-btn') && !e.target.closest('.tag-dropdown')) {
            document.querySelectorAll('.tag-dropdown').forEach(d => {
                d.classList.remove('show');
            });
        }
    });

    function downloadMod(downloadLink) {
        if (!downloadLink || downloadLink.trim() === '') {
            alert('–°—Å—ã–ª–∫–∞ –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç');
            return;
        }
        window.open(downloadLink, '_blank');
    }

    document.addEventListener('DOMContentLoaded', function() {
        document.querySelectorAll('.dropdown-btn').forEach(button => {
            button.addEventListener('click', function(e) {
                e.stopPropagation();
                const dropdown = this.nextElementSibling;
                dropdown.classList.toggle('show');
            });
        });

        window.addEventListener('click', function(e) {
            if (!e.target.matches('.dropdown-btn')) {
                document.querySelectorAll('.dropdown-content').forEach(dropdown => {
                    if (dropdown.classList.contains('show')) {
                        dropdown.classList.remove('show');
                    }
                });
            }
        });
    });

    function filterByTag(tagId) {
        // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–µ –∞–∫—Ç–∏–≤–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã –∏–∑ URL
        const urlParams = new URLSearchParams(window.location.search);
        const currentFilters = urlParams.getAll('tag_ids');
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —Ç–µ–≥ –≤ —Ç–µ–∫—É—â–∏—Ö —Ñ–∏–ª—å—Ç—Ä–∞—Ö
        if (currentFilters.includes(tagId.toString())) {
            // –ï—Å–ª–∏ –µ—Å—Ç—å, —É–¥–∞–ª—è–µ–º –µ–≥–æ
            const newFilters = currentFilters.filter(id => id !== tagId.toString());
            redirectToFilter(newFilters);
        } else {
            // –ï—Å–ª–∏ –Ω–µ—Ç, –¥–æ–±–∞–≤–ª—è–µ–º –∫ —Ç–µ–∫—É—â–∏–º —Ñ–∏–ª—å—Ç—Ä–∞–º
            if (!currentFilters.includes(tagId.toString())) {
                currentFilters.push(tagId.toString());
            }
            redirectToFilter(currentFilters);
        }
    }

    function redirectToFilter(tagIds) {
        if (tagIds.length === 0) {
            window.location.href = '/';
        } else {
            const params = new URLSearchParams();
            tagIds.forEach(tagId => params.append('tag_ids', tagId));
            window.location.href = `/filter_by_tags?${params.toString()}`;
        }
    }
    
    function removeTagFromMod(event, modId, tagId) {
        event.stopPropagation();
        
        if (confirm('–£–¥–∞–ª–∏—Ç—å —Ç–µ–≥ –∏–∑ —ç—Ç–æ–≥–æ –º–æ–¥–∞?')) {
            const deleteButton = event.target;
            const originalText = deleteButton.textContent;
            deleteButton.textContent = '√ó';
            deleteButton.disabled = true;
            
            fetch(`/mod/${modId}/remove_tag/${tagId}`, {
                method: 'POST',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // –ù–∞—Ö–æ–¥–∏–º –∏ —É–¥–∞–ª—è–µ–º —ç–ª–µ–º–µ–Ω—Ç —Ç–µ–≥–∞
                    const tagElement = event.target.closest('.assigned-tag-container');
                    tagElement.remove();
                    
                    showFlashMessage('–¢–µ–≥ —É–¥–∞–ª–µ–Ω –∏–∑ –º–æ–¥–∞', 'success');
                } else {
                    showFlashMessage('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Ç–µ–≥–∞', 'danger');
                }
            })
            .catch(error => {
                showFlashMessage('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Ç–µ–≥–∞', 'danger');
            })
            .finally(() => {
                deleteButton.textContent = originalText;
                deleteButton.disabled = false;
            });
        }
    }

    function addTagToMod(event, modId, tagId) {
        event.preventDefault();
        
        const button = event.target;
        const originalText = button.textContent;
        button.textContent = '...';
        button.disabled = true;
        
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º AJAX-–∑–∞–ø—Ä–æ—Å
        fetch(`/mod/${modId}/add_tag/${tagId}`, {
            method: 'POST',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'Content-Type': 'application/x-www-form-urlencoded',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // –£—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ - –æ–±–Ω–æ–≤–ª—è–µ–º –∫–∞—Ä—Ç–æ—á–∫—É
                const tagContainer = document.querySelector(`.card[data-mod-id="${modId}"] .assigned-tags`);
                
                // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π —ç–ª–µ–º–µ–Ω—Ç —Ç–µ–≥–∞
                const tagElement = document.createElement('div');
                tagElement.className = 'assigned-tag-container';
                tagElement.innerHTML = `
                    <span class="assigned-tag" onclick="filterByTag(${data.tag_id})">
                        ${data.tag_name}
                        <span class="assigned-tag-delete" onclick="removeTagFromMod(event, ${modId}, ${data.tag_id})">√ó</span>
                    </span>
                `;
                
                // –ù–∞—Ö–æ–¥–∏–º –ø–ª—é—Å–∏–∫ –∏ –≤—Å—Ç–∞–≤–ª—è–µ–º —Ç–µ–≥ –ø–µ—Ä–µ–¥ –Ω–∏–º
                const plusButton = tagContainer.querySelector('.tag-plus-btn');
                tagContainer.insertBefore(tagElement, plusButton);
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
                showFlashMessage(data.message, 'success');
                
                // –ó–∞–∫—Ä—ã–≤–∞–µ–º –≤—ã–ø–∞–¥–∞—é—â–∏–π —Å–ø–∏—Å–æ–∫
                const dropdown = plusButton.closest('.card').querySelector('.tag-dropdown');
                dropdown.classList.remove('show');
            } else {
                showFlashMessage(data.message, 'danger');
            }
        })
        .catch(error => {
            showFlashMessage('–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ —Ç–µ–≥–∞', 'danger');
        })
        .finally(() => {
            button.textContent = originalText;
            button.disabled = false;
        });
    }

    function showFlashMessage(message, type) {
        // –°–æ–∑–¥–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç —Å–æ–æ–±—â–µ–Ω–∏—è
        const flashDiv = document.createElement('div');
        flashDiv.className = `flash-${type}`;
        flashDiv.textContent = message;
        flashDiv.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 20px;
            border-radius: 6px;
            color: white;
            font-weight: 500;
            z-index: 10000;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            animation: slideIn 0.3s ease;
        `;
        
        if (type === 'success') {
            flashDiv.style.background = '#28a745';
        } else {
            flashDiv.style.background = '#dc3545';
        }
        
        document.body.appendChild(flashDiv);
        
        // –£–¥–∞–ª—è–µ–º —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
        setTimeout(() => {
            flashDiv.remove();
        }, 3000);
    }

    // –û–±–Ω–æ–≤–ª—è–µ–º —Ñ—É–Ω–∫—Ü–∏—é toggleTagDropdown
    function toggleTagDropdown(button) {
        const dropdown = button.nextElementSibling;
        dropdown.classList.toggle('show');
        
        // –ó–∞–∫—Ä—ã—Ç—å –¥—Ä—É–≥–∏–µ –≤—ã–ø–∞–¥–∞—é—â–∏–µ —Å–ø–∏—Å–∫–∏
        document.querySelectorAll('.tag-dropdown').forEach(d => {
            if (d !== dropdown && d.classList.contains('show')) {
                d.classList.remove('show');
            }
        });
    }

    // –û–±–Ω–æ–≤–ª—è–µ–º —Ñ—É–Ω–∫—Ü–∏—é –¥–ª—è –ø–ª—é—Å–∏–∫–∞
    function updatePlusButton(modId, tagId) {
        const plusButton = event.target.closest('.tag-plus-btn');
        addTagToMod(event, modId, tagId);
    }

    document.addEventListener('DOMContentLoaded', () => {
        const canvas = document.getElementById('sparkleCanvas');
        if (!canvas) return;
        const ctx = canvas.getContext('2d');

        // –ê–¥–∞–ø—Ç–∞—Ü–∏—è –ø–æ–¥ —Ä–∞–∑–º–µ—Ä header
        const resizeCanvas = () => {
            const rect = canvas.parentElement.getBoundingClientRect();
            canvas.width = rect.width;
            canvas.height = rect.height;
        };
        resizeCanvas();
        window.addEventListener('resize', resizeCanvas);

        // === –ú–µ–ª–∫–∏–µ –±–ª–µ—Å—Ç–∫–∏ (80 —à—Ç) ===
        const sparkles = [];
        const count = 500;

        for (let i = 0; i < count; i++) {
            sparkles.push({
                x: Math.random() * canvas.width,
                y: Math.random() * canvas.height,
                baseRadius: Math.random() * 0.3 + 0.1, // 0.5‚Äì1.5px
                pulseSpeed: Math.random() * 4 + 3, // 0.5‚Äì1.3 –ì—Ü
                phase: Math.random() * Math.PI * 2,
            });
        }

        // === –ê–Ω–∏–º–∞—Ü–∏—è ===
        function animate() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            const t = Date.now() / 1000;

            // –†–∏—Å—É–µ–º –º–µ–ª–∫–∏–µ –±–ª–µ—Å—Ç–∫–∏
            for (const s of sparkles) {
                const pulse = Math.sin(t * s.pulseSpeed + s.phase) * 0.5 + 0.5; // 0 ‚Üí 1
                const radius = s.baseRadius * (1 + pulse * 0.8);
                const opacity = 0.3 + pulse * 0.7;

                ctx.beginPath();
                ctx.arc(s.x, s.y, radius, 0, Math.PI * 2);
                ctx.fillStyle = `rgba(255, 255, 255, ${opacity})`;
                ctx.fill();

                // –§–∏–æ–ª–µ—Ç–æ–≤–æ–µ —Å–≤–µ—á–µ–Ω–∏–µ
                ctx.shadowBlur = 10 * pulse;
                ctx.shadowColor = `rgba(139, 92, 246, ${pulse * 0.6})`;
                ctx.fill();
                ctx.shadowBlur = 0;
            }

            requestAnimationFrame(animate);
        }

        animate();
    });
    </script>
</body>
</html>